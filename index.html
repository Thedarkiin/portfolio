<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sanctuary</title>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "gsap": "https://unpkg.com/gsap@3.12.5/index.js"
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400&display=swap');

        body, html {
            margin: 0; overflow: hidden; background-color: #000a12;
            font-family: 'Inter', sans-serif; color: #e0e0e0; cursor: default;
            transition: background-color 3s ease; user-select: none;
        }

        #ui-layer { position: fixed; inset: 0; z-index: 10; pointer-events: none; }

        /* --- CINEMATIC LOADER --- */
        #loader {
            position: fixed; inset: 0; background: #020406; z-index: 300;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Cinzel', serif;
        }
        .loader-ring {
            width: 80px; height: 80px; border: 2px solid rgba(197, 160, 89, 0.1);
            border-top: 2px solid #c5a059; border-radius: 50%;
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.1);
        }
        .loader-text {
            color: #c5a059; letter-spacing: 8px; font-size: 0.9rem;
            animation: pulse 2s infinite; text-transform: uppercase;
        }
        #load-bar-container {
            width: 250px; height: 3px; background: #1a1a1a; margin-top: 20px; 
            border-radius: 4px; overflow: hidden; position: relative;
        }
        #load-fill {
            width: 0%; height: 100%; background: #c5a059; 
            box-shadow: 0 0 10px #c5a059; transition: width 0.1s linear;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* --- INTRO SCREEN --- */
        #intro-screen {
            position: fixed; inset: 0; background: rgba(2, 4, 6, 0.95); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto; transition: opacity 1.5s ease-out;
            backdrop-filter: blur(20px);
        }
        #start-btn {
            padding: 20px 60px; background: transparent; 
            border: 1px solid rgba(197, 160, 89, 0.5);
            color: #c5a059; font-family: 'Cinzel'; font-size: 1.5rem; letter-spacing: 8px;
            cursor: pointer; transition: 0.4s; text-transform: uppercase;
            position: relative; overflow: hidden;
        }
        #start-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(197, 160, 89, 0.2), transparent);
            transition: 0.5s;
        }
        #start-btn:hover { border-color: #ffd700; color: #ffd700; box-shadow: 0 0 30px rgba(197, 160, 89, 0.2); }
        #start-btn:hover::before { left: 100%; }

        /* --- CONTROLS & WIDGETS --- */
        .controls { 
            position: absolute; top: 30px; left: 30px; 
            display: flex; gap: 15px; pointer-events: auto; 
        }
        .btn-icon {
            width: 44px; height: 44px; border-radius: 8px; background: rgba(5, 10, 15, 0.6);
            border: 1px solid rgba(255,255,255,0.1); color: #8a9bb0; font-size: 1.1rem;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            backdrop-filter: blur(5px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-icon:hover, .btn-icon.active { background: rgba(197, 160, 89, 0.1); color: #ffd700; border-color: #ffd700; }

        /* NEW WEATHER WIDGET */
        #weather-widget {
            position: absolute; top: 30px; right: 30px;
            padding: 12px 24px; background: rgba(5, 10, 15, 0.4);
            border-left: 3px solid #c5a059; border-radius: 2px;
            font-family: 'JetBrains Mono', monospace; color: #c5a059;
            backdrop-filter: blur(8px); text-transform: uppercase;
            font-size: 0.85rem; letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 4px;
            transition: all 0.5s ease;
        }
        #weather-widget span { font-size: 0.7rem; color: #8a9bb0; letter-spacing: 1px; }

        /* --- HUD --- */
        .hud-action {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            font-family: 'Cinzel', serif; font-size: 0.8rem; color: rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.1); padding: 8px 20px; border-radius: 4px;
            pointer-events: none; letter-spacing: 2px; text-transform: uppercase;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
        }

        /* --- MINIMAP ENHANCED --- */
        #minimap-container {
            position: absolute; bottom: 30px; right: 30px; width: 180px; height: 180px;
            pointer-events: auto; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
            opacity: 1;
        }
        #minimap-container.hidden { transform: translateY(20px) scale(0.9); opacity: 0; pointer-events: none; }
        
        #minimap {
            width: 100%; height: 100%; border-radius: 50%; 
            border: 2px solid rgba(197, 160, 89, 0.3); overflow: hidden;
            background: radial-gradient(circle, #0b151d 0%, #000000 100%);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        #minimap::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: repeating-linear-gradient(0deg, transparent 0, transparent 19px, rgba(197, 160, 89, 0.1) 20px);
            pointer-events: none;
        }
        #minimap-arrow {
            position: absolute; top: 50%; left: 50%; width: 12px; height: 12px;
            background: #ff4444; border: 2px solid #fff; border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 55;
            box-shadow: 0 0 10px #ff4444;
        }

        /* --- INTERACTION PROMPT --- */
        .interact-prompt {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; flex-direction: column; align-items: center; gap: 8px;
            pointer-events: none;
        }
        .interact-key {
            width: 30px; height: 30px; border: 1px solid #ffd700; color: #ffd700;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Cinzel'; font-weight: bold; border-radius: 4px;
            background: rgba(0,0,0,0.5); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            animation: bounce 1s infinite alternate;
        }
        .interact-label {
            color: #ffd700; font-family: 'Cinzel'; font-size: 0.8rem; letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        @keyframes bounce { from{transform:translateY(0)} to{transform:translateY(-5px)} }

        /* --- RPG DIALOGUE --- */
        #rpg-ui {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%) translateY(20px);
            width: 90%; max-width: 650px; background: rgba(5, 8, 12, 0.95);
            border: 1px solid rgba(74, 90, 106, 0.5); border-radius: 4px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.9); display: none; opacity: 0;
            transition: 0.5s; pointer-events: auto; z-index: 50; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        #rpg-ui.active { display: block; opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .rpg-inner { display: flex; padding: 25px; gap: 20px; align-items: flex-start; }
        .rpg-portrait {
            width: 70px; height: 70px; background: #0b1015; border: 1px solid #c5a059;
            display: flex; justify-content: center; align-items: center; font-size: 2.2rem;
            box-shadow: inset 0 0 20px rgba(197, 160, 89, 0.1); flex-shrink: 0;
        }
        .rpg-name { color: #c5a059; font-family: 'Cinzel'; font-size: 0.9rem; margin-bottom: 8px; letter-spacing: 2px; text-transform: uppercase; }
        .rpg-text { 
            color: #d0d0d0; font-size: 1.05rem; line-height: 1.8; 
            font-family: 'Cinzel', serif; letter-spacing: 0.5px;
        }
        
        .rpg-choices { 
            background: rgba(0,0,0,0.3); padding: 15px 25px; display: flex; 
            gap: 15px; justify-content: flex-end; border-top: 1px solid rgba(255,255,255,0.05);
        }
        .rpg-btn {
            background: transparent; border: 1px solid rgba(170, 221, 255, 0.3); color: #aaddff;
            padding: 8px 18px; border-radius: 2px; cursor: pointer; font-family: 'Inter';
            font-size: 0.8rem; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        .rpg-btn:hover { background: rgba(170, 221, 255, 0.1); color: #fff; border-color: #fff; }

        /* --- PORTFOLIO MODAL --- */
        #portfolio-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(15px); z-index: 100; display: flex;
            justify-content: center; align-items: center; opacity: 0;
            pointer-events: none; transition: opacity 0.6s ease;
        }
        #portfolio-modal.active { opacity: 1; pointer-events: auto; }

        .glass-card {
            width: 85vw; max-width: 1000px; height: 80vh; 
            background: linear-gradient(160deg, #0e1217 0%, #030405 100%);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; 
            display: grid; grid-template-columns: 240px 1fr; 
            overflow: hidden; position: relative;
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
        }
        
        .p-sidebar {
            background: rgba(255,255,255,0.02); border-right: 1px solid rgba(255,255,255,0.05);
            padding: 40px 20px; display: flex; flex-direction: column; gap: 8px;
        }
        .p-nav-header {
            color: #4a5a6a; margin-bottom: 20px; font-size: 0.7rem; 
            letter-spacing: 3px; font-weight: bold; padding-left: 15px; font-family: 'Inter';
        }
        .p-nav {
            padding: 12px 15px; color: #8a9bb0; cursor: pointer; font-family: 'Cinzel'; 
            font-size: 0.9rem; transition: 0.3s; letter-spacing: 1px; border-radius: 6px;
        }
        .p-nav:hover { background: rgba(255,255,255,0.03); color: #e0e0e0; }
        .p-nav.active { 
            background: rgba(197, 160, 89, 0.1);
            color: #ffd700; border-left: 3px solid #ffd700; 
        }

        .p-content { padding: 50px 60px; overflow-y: auto; color: #bfbfbf; position: relative; }
        
        .section { display: none; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .section.active { display: block; }
        @keyframes slideUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }

        h2 { font-family: 'Cinzel'; color: #fff; font-size: 2.5rem; margin: 0 0 10px 0; letter-spacing: -0.5px; }
        .subtitle { font-family: 'Cinzel'; color: #c5a059; font-size: 0.8rem; margin-bottom: 40px; display: block; letter-spacing: 2px;}
        p { line-height: 1.8; font-size: 1rem; color: #a0aab5; margin-bottom: 20px; }
        strong { color: #fff; font-weight: 600; }

        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .data-card {
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
            padding: 25px; border-radius: 8px; transition: 0.3s;
        }
        .data-card:hover { 
            background: rgba(255,255,255,0.04); border-color: rgba(197, 160, 89, 0.3); 
            transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .data-card h3 { 
            font-family: 'Cinzel'; font-size: 1.1rem; color: #e0e0e0; margin: 0 0 10px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;
        }
        .data-card p { font-size: 0.9rem; margin: 0; }

        .quote-box {
            border-left: 3px solid #c5a059; background: linear-gradient(90deg, rgba(197,160,89,0.1), transparent);
            padding: 20px; margin-top: 30px; font-style: italic; color: #e0e0e0;
        }

        .close-x-btn { 
            position: absolute; top: 20px; right: 20px; 
            width: 40px; height: 40px; z-index: 101;
            display: flex; justify-content: center; align-items: center;
            color: #666; cursor: pointer; font-size: 1.2rem; transition:0.3s; 
            font-family: 'Inter'; border-radius: 50%;
        }
        .close-x-btn:hover { color: #fff; background: rgba(255,255,255,0.1); transform: rotate(90deg); }

        @media (max-width: 800px) {
            .glass-card { grid-template-columns: 1fr; height: 90vh; }
            .p-sidebar { flex-direction: row; padding: 15px; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); overflow-x: auto; }
            .p-content { padding: 30px; }
        }
    </style>
</head>
<body>

    <!-- UPDATED LOADER -->
    <div id="loader">
        <div class="loader-ring"></div>
        <div class="loader-text">CALIBRATING COMPASS...</div>
        <div id="load-bar-container">
            <div id="load-fill"></div>
        </div>
    </div>

    <!-- INTRO -->
    <div id="intro-screen">
        <button id="start-btn">ENTER</button>
    </div>

    <div id="ui-layer">
        <div class="controls">
            <div class="btn-icon" id="sound-btn" title="Toggle Audio">üîá</div>
            <div class="btn-icon" id="theme-btn" title="Toggle Cycle">‚òÄÔ∏è</div>
        </div>
        
        <!-- WEATHER WIDGET -->
        <div id="weather-widget">
            <div id="ww-status">STATUS: SUNRISE</div>
            <span id="ww-temp">TEMP: 14¬∞C</span>
        </div>

        <div class="hud-action">[SPACE] FIRE CANNON</div>

        <div class="interact-prompt" id="npc-prompt">
            <div class="interact-key">E</div>
            <div class="interact-label">INTERACT</div>
        </div>
        
        <div id="minimap-container">
            <div id="minimap"></div>
            <div id="minimap-arrow"></div>
        </div>
    </div>

    <!-- RPG UI -->
    <div id="rpg-ui">
        <div class="rpg-inner">
            <div class="rpg-portrait">üßô‚Äç‚ôÇÔ∏è</div>
            <div class="rpg-main">
                <div class="rpg-name">Keeper of the Tides</div>
                <div class="rpg-text" id="rpg-text"></div>
            </div>
        </div>
        <div class="rpg-choices" id="rpg-options"></div>
    </div>

    <!-- PORTFOLIO -->
    <div id="portfolio-modal">
        <div class="glass-card">
            <div class="close-x-btn" onclick="Game.closePortfolio()" title="Close Archive">‚úï</div>
            
            <div class="p-sidebar">
                <div class="p-nav-header">LOGBOOK</div>
                <div class="p-nav active" onclick="Game.nav('about')">Captain</div>
                <div class="p-nav" onclick="Game.nav('interests')">Discoveries</div>
                <div class="p-nav" onclick="Game.nav('contact')">Signal</div>
            </div>
            
            <div class="p-content">
                <div id="sec-about" class="section active"></div>
                <div id="sec-interests" class="section"></div>
                <div id="sec-contact" class="section"></div>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { Water } from 'three/addons/objects/Water.js';
        import { Sky } from 'three/addons/objects/Sky.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import gsap from 'gsap';

        const CONFIG = {
            day: {
                ambient: 0.7,
                dirIntensity: 1.8,
                sunColor: 0xffaa33, 
                fog: 0x8899aa, // Slightly clearer for sunrise
                fogDensity: 0.006, // Less fog to see the sun/horizon
                sky: { elevation: 7, azimuth: 180 } 
            },
            night: {
                ambient: 0.1,
                dirIntensity: 0.2,
                sunColor: 0x6677aa,
                fog: 0x05070a,
                fogDensity: 0.015,
                sky: { elevation: -5, azimuth: 180 }
            }
        };

        const CONTENT = {
            about: `
                <h2>Yassin Asermouh</h2>
                <span class="subtitle">STATE ENGINEER CANDIDATE // INSEA</span>
                <div class="quote-box">"My goal is to bridge the gap between theoretical mathematics and practical AI implementation."</div>
                <br>
                <p>I am currently pursuing a State Engineer degree at the <strong>National Institute of Statistics and Applied Economics (INSEA)</strong>. My work exists at the intersection of rigorous mathematical theory and cutting-edge machine learning.</p>
                <div class="data-grid">
                    <div class="data-card"><h3>Core Focus</h3><p>Optimization Landscapes, Probability Theory, Structural Mechanics of Neural Networks.</p></div>
                    <div class="data-card"><h3>Methodology</h3><p>First-principles thinking applied to complex system architecture.</p></div>
                </div>
            `,
            interests: `
                <h2>Active Modules</h2>
                <span class="subtitle">PASSIONS & PURSUITS</span>
                <div class="data-grid">
                    <div class="data-card"><h3>Neuropsychology</h3><p>Analyzing biological intelligence structures to inform better artificial system design.</p></div>
                    <div class="data-card"><h3>Civic Impact</h3><p>Volunteer at INSEA Charity Club. Leveraging design and engineering for social good.</p></div>
                    <div class="data-card"><h3>Physicality</h3><p>Football, Calisthenics, Volleyball, Tennis, Swimming. Maintaining the hardware.</p></div>
                    <div class="data-card"><h3>Design</h3><p>Creating visual assets and interactive 3D experiences.</p></div>
                </div>
            `,
            contact: `
                <h2>Establish Uplink</h2>
                <span class="subtitle">OPEN FOR COLLABORATION</span>
                <p>I am available for research collaborations, engineering roles, and technical discourse.</p>
                <div style="margin-top:40px; padding:30px; border:1px solid rgba(197, 160, 89, 0.3); border-radius:8px; text-align:center;">
                    <a href="mailto:asermouyassing@gmail.com" style="color:#ffd700; font-size:1.5rem; text-decoration:none; font-family:'Cinzel'; display:block; margin-bottom:10px;">asermouyassing@gmail.com</a>
                    <span style="color:#666; font-size:0.8rem; letter-spacing:2px;">SECURE CHANNEL</span>
                </div>
                <div class="data-grid">
                    <div class="data-card" style="text-align:center; cursor:pointer;"><h3>LinkedIn</h3><p>Professional Profile ‚Üó</p></div>
                    <div class="data-card" style="text-align:center; cursor:pointer;"><h3>GitHub</h3><p>Code Repository ‚Üó</p></div>
                    <div class="data-card" style="text-align:center; cursor:pointer;"><h3>Discord</h3><p>Direct Comms ‚Üó</p></div>
                </div>
            `
        };

        // --- AUDIO ENGINE (MP3 Player Version) ---
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.gainNode = null;
                this.audioElement = null;
                this.isMuted = true;
            }

            init() {
                if(this.ctx) return;
                
                // 1. Create the Audio Context
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();

                // 2. Create the Master Volume (Gain)
                this.gainNode = this.ctx.createGain();
                this.gainNode.gain.value = 0.05; // Keep volume low and calm
                this.gainNode.connect(this.ctx.destination);

                // 3. Load the MP3 File
                this.audioElement = new Audio('music.mp3'); // Make sure your file is named music.mp3
                this.audioElement.loop = true; // Loop forever
                this.audioElement.crossOrigin = "anonymous";

                // 4. Connect HTML Audio to Web Audio API
                // This allows us to control volume/mute smoothly
                const track = this.ctx.createMediaElementSource(this.audioElement);
                track.connect(this.gainNode);

                // 5. Play (Browser requires user interaction first, which happens when you click 'ENTER')
                this.audioElement.play().catch(e => console.log("Audio wait for interaction"));
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                if(this.ctx) {
                    // Smooth fade in/out
                    const target = this.isMuted ? 0 : 0.05;
                    this.gainNode.gain.setTargetAtTime(target, this.ctx.currentTime, 0.5);
                    
                    // Resume context if it was suspended by the browser
                    if (this.ctx.state === 'suspended') {
                        this.ctx.resume();
                    }
                }
                return this.isMuted;
            }
        }

        const Game = {
            scene: null, camera: null, renderer: null, controls: null,
            water: null, sky: null, sun: null,
            objects: { boat: null, npc: null, fireflies: null, birds: null, moon: null, lanterns: null, whale: null, supplyCrates: [], explosions: [] },
            lights: { dir: null, amb: null },
            state: { night: false, docked: false, talking: false, mapVisible: true, canTalk: false, keys: {w:0,a:0,s:0,d:0}, whaleState: { t: 0, jumping: false } },
            physics: { speed: 0, angle: Math.PI, vel: new THREE.Vector3(), accel: 0.015, fric: 0.98, turn: 0.02, max: 0.8 },
            audio: new AudioEngine(),
            minimap: { renderer:null, scene:null, camera:null },

            init: function() {
                document.getElementById('sec-about').innerHTML = CONTENT.about;
                document.getElementById('sec-interests').innerHTML = CONTENT.interests;
                document.getElementById('sec-contact').innerHTML = CONTENT.contact;

                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);

                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x001e28);
                this.scene.fog = new THREE.FogExp2(0x001e28, 0.005);

                this.camera = new THREE.PerspectiveCamera(55, window.innerWidth/window.innerHeight, 1, 20000);
                this.camera.position.set(0, 20, 40);

                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enablePan = false;
                this.controls.enableDamping = true;
                this.controls.minDistance = 20;
                this.controls.maxDistance = 80;
                this.controls.maxPolarAngle = Math.PI/2 - 0.05;

                this.buildWorld();
                this.buildMinimap();
                this.bindEvents();

                let p=0;
                const int = setInterval(()=>{
                    p+=2; document.getElementById('load-fill').style.width=p+'%';
                    if(p>=100) {
                        clearInterval(int);
                        gsap.to('#loader', {opacity:0, duration:0.8, onComplete:()=>document.getElementById('loader').remove()});
                    }
                },20);

                window.Game = this;
                this.animate();
            },

            bindEvents: function() {
                window.addEventListener('resize', () => this.onResize());
                window.addEventListener('keydown', e => this.key(e, 1));
                window.addEventListener('keyup', e => this.key(e, 0));
                document.getElementById('start-btn').onclick = () => this.start();
                document.getElementById('theme-btn').onclick = () => this.toggleTheme();
                document.getElementById('sound-btn').onclick = () => this.toggleAudio();
            },

            key: function(e, v) {
                const k = e.key.toLowerCase();
                if(k==='w'||k==='arrowup') this.state.keys.w=v;
                if(k==='s'||k==='arrowdown') this.state.keys.s=v;
                if(k==='a'||k==='arrowleft') this.state.keys.a=v;
                if(k==='d'||k==='arrowright') this.state.keys.d=v;
                
                if(v && k===' ') this.shoot();
                if(v && k==='e' && this.state.canTalk && !this.state.talking) this.startDialogue();
            },

            start: function() {
                gsap.to('#intro-screen', {opacity:0, duration:1, onComplete:()=>{
                    document.getElementById('intro-screen').style.display='none';
                    this.audio.init();
                    this.audio.toggleMute();
                    document.getElementById('sound-btn').innerText = 'üîä';
                }});
            },

            toggleAudio: function() {
                const m = this.audio.toggleMute();
                document.getElementById('sound-btn').innerText = m ? 'üîá' : 'üîä';
            },

            buildWorld: function() {
                this.lights.amb = new THREE.AmbientLight(0xffffff, CONFIG.day.ambient);
                this.scene.add(this.lights.amb);
                this.lights.dir = new THREE.DirectionalLight(CONFIG.day.sunColor, CONFIG.day.dirIntensity);
                this.lights.dir.position.set(100, 50, -50);
                this.lights.dir.castShadow = true;
                this.lights.dir.shadow.mapSize.set(2048,2048);
                this.scene.add(this.lights.dir);

                const wGeo = new THREE.PlaneGeometry(10000,10000);
                this.water = new Water(wGeo, {
                    textureWidth: 512, textureHeight: 512,
                    waterNormals: new THREE.TextureLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/waternormals.jpg', t => t.wrapS=t.wrapT=THREE.RepeatWrapping),
                    sunDirection: this.lights.dir.position.clone().normalize(),
                    sunColor: CONFIG.day.sunColor, waterColor: 0x001e0f, distortionScale: 3.7, fog: true
                });
                this.water.rotation.x = -Math.PI/2;
                this.scene.add(this.water);

                this.sky = new Sky();
                this.sky.scale.setScalar(10000);
                this.sky.material.uniforms.turbidity.value = 10;
                this.sky.material.uniforms.rayleigh.value = 3;
                this.sky.material.uniforms.mieCoefficient.value = 0.005;
                this.sky.material.uniforms.mieDirectionalG.value = 0.7;
                this.scene.add(this.sky);
                this.sun = new THREE.Vector3();
                this.updateSky(CONFIG.day.sky.elevation); 

                this.buildIsland();
                this.buildBoat();
                this.buildWhale(); 
                this.buildEffects();
                this.buildLanterns();
                this.buildCrates(); 
            },

            updateSky: function(elevation) {
                const phi = THREE.MathUtils.degToRad(90 - elevation);
                const theta = THREE.MathUtils.degToRad(180);
                this.sun.setFromSphericalCoords(1, phi, theta);
                this.sky.material.uniforms.sunPosition.value.copy(this.sun);
                this.water.material.uniforms.sunDirection.value.copy(this.sun).normalize();
                this.scene.environment = new THREE.PMREMGenerator(this.renderer).fromScene(this.sky).texture;
            },

            buildIsland: function() {
                const g = new THREE.Group();
                const rockGeo = new THREE.CylinderGeometry(20, 15, 35, 32, 5); 
                rockGeo.translate(0, 10, 0);
                const pos = rockGeo.attributes.position;
                for(let i=0; i<pos.count; i++){
                    const x = pos.getX(i);
                    const y = pos.getY(i);
                    const z = pos.getZ(i);
                    if (y < 26) {
                        const noise = Math.sin(x*0.3) * Math.cos(z*0.3) * 2 + Math.sin(y*0.5)*1.5 + (Math.random()-0.5)*1.5;
                        const factor = 1 + (noise * 0.05);
                        pos.setX(i, x * factor);
                        pos.setZ(i, z * factor);
                    }
                }
                rockGeo.computeVertexNormals();
                const rock = new THREE.Mesh(rockGeo, new THREE.MeshStandardMaterial({color:0x2c2c2c, roughness:0.9, flatShading:true}));
                g.add(rock);

                const plat = new THREE.Mesh(new THREE.CylinderGeometry(21, 20, 4, 9), new THREE.MeshStandardMaterial({color:0x2d4c1e}));
                plat.position.y = 28; g.add(plat);

                const tower = new THREE.Group(); tower.position.y = 30;
                const base = new THREE.Mesh(new THREE.CylinderGeometry(6, 7, 15, 8), new THREE.MeshStandardMaterial({color:0x555, flatShading:true}));
                base.position.y = 7.5; tower.add(base);
                const mid = new THREE.Mesh(new THREE.CylinderGeometry(7, 6, 2, 8), new THREE.MeshStandardMaterial({color:0x333}));
                mid.position.y = 15; tower.add(mid);
                const roof = new THREE.Mesh(new THREE.ConeGeometry(8, 12, 8), new THREE.MeshStandardMaterial({color:0x223344}));
                roof.position.y = 22; tower.add(roof);
                const win = new THREE.Mesh(new THREE.PlaneGeometry(2, 4), new THREE.MeshBasicMaterial({color:0xffaa00}));
                win.position.set(0, 10, 6.5); tower.add(win);
                const twL = new THREE.PointLight(0xffaa00, 1, 40); twL.position.set(0, 10, 8); twL.name='houseLight'; tower.add(twL);
                g.add(tower);

                const dock = new THREE.Mesh(new THREE.BoxGeometry(8, 1, 30), new THREE.MeshStandardMaterial({color:0x4e342e}));
                dock.position.set(0, 2, 45); g.add(dock);

                const npc = new THREE.Group(); npc.position.set(0, 3, 52);
                npc.add(new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.7, 3), new THREE.MeshStandardMaterial({color:0x111})).translateY(1.5));
                npc.add(new THREE.Mesh(new THREE.DodecahedronGeometry(0.5), new THREE.MeshStandardMaterial({color:0x222})).translateY(3.2));
                const staff = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,5), new THREE.MeshStandardMaterial({color:0x5d4037}));
                staff.position.set(0.8, 2.5, 0.2); npc.add(staff);
                const orb = new THREE.Mesh(new THREE.OctahedronGeometry(0.2), new THREE.MeshStandardMaterial({color:0x00ffff, emissive:0x00aaaa, emissiveIntensity:2}));
                orb.position.set(0.8, 5, 0.2); npc.add(orb);
                const npcLight = new THREE.PointLight(0x00ffff, 1, 10);
                npcLight.position.set(0, 4, 0); npc.add(npcLight);
                this.objects.npc = npc;
                g.add(npc);

                for(let i=0; i<8; i++) {
                    const t = new THREE.Group();
                    t.add(new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.5,6), new THREE.MeshStandardMaterial({color:0x3e2723})).translateY(3));
                    const can = new THREE.Mesh(new THREE.SphereGeometry(3,8,8,0,Math.PI*2,0,Math.PI/2), new THREE.MeshStandardMaterial({color:0x2e5a1c, side:2}));
                    can.position.y=5; can.scale.y=1.5; t.add(can);
                    const a=Math.random()*Math.PI*2, r=12+Math.random()*6;
                    t.position.set(Math.cos(a)*r, 30, Math.sin(a)*r); 
                    t.rotation.z = (Math.random()-0.5)*0.3;
                    g.add(t);
                }
                this.scene.add(g);
            },

            buildWhale: function() {
                const g = new THREE.Group();
                
                // Improved Deformed Sphere for organic body
                const bodyGeo = new THREE.SphereGeometry(6, 32, 32);
                const pos = bodyGeo.attributes.position;
                for(let i=0; i<pos.count; i++){
                    const v = new THREE.Vector3();
                    v.fromBufferAttribute(pos, i);
                    
                    // Elongate length
                    v.z *= 3.5; 
                    
                    // Taper Tail
                    if(v.z > 0) {
                        const taper = Math.max(0.1, 1 - (v.z / 20));
                        v.x *= taper;
                        v.y *= taper;
                    }
                    // Bulky Head
                    if(v.z < -5) {
                        v.y *= 0.8; // Flatten snout slightly
                        v.x *= 0.9;
                    }
                    pos.setXYZ(i, v.x, v.y, v.z);
                }
                bodyGeo.computeVertexNormals();
                const body = new THREE.Mesh(bodyGeo, new THREE.MeshStandardMaterial({
                    color:0x1a2b3c, roughness:0.15, metalness:0.1 // Wet look
                }));
                g.add(body);

                // Tail Flukes
                const tailGeo = new THREE.BoxGeometry(12, 0.5, 4);
                const tail = new THREE.Mesh(tailGeo, new THREE.MeshStandardMaterial({color:0x1a2b3c, roughness:0.2}));
                tail.position.set(0, 0, 18);
                g.add(tail);

                // Fins
                const finGeo = new THREE.BoxGeometry(8, 0.5, 3);
                const lFin = new THREE.Mesh(finGeo, new THREE.MeshStandardMaterial({color:0x1a2b3c, roughness:0.2}));
                lFin.position.set(5, -2, -2); lFin.rotation.z = -0.5; lFin.rotation.y = 0.5;
                const rFin = new THREE.Mesh(finGeo, new THREE.MeshStandardMaterial({color:0x1a2b3c, roughness:0.2}));
                rFin.position.set(-5, -2, -2); rFin.rotation.z = 0.5; rFin.rotation.y = -0.5;
                g.add(lFin); g.add(rFin);

                // Scale up significantly
                g.scale.setScalar(1.5);

                this.objects.whale = g;
                this.objects.whale.position.set(0, -30, -100); 
                this.scene.add(g);
            },

            buildCrates: function() {
                const g = new THREE.Group();
                const geo = new THREE.BoxGeometry(2,2,2);
                const mat = new THREE.MeshStandardMaterial({color:0x8d6e63});
                
                for(let i=0; i<5; i++) {
                    const c = new THREE.Mesh(geo, mat);
                    c.position.set((Math.random()-0.5)*100, 0, (Math.random()-0.5)*100);
                    c.rotation.set(Math.random(), Math.random(), Math.random());
                    c.userData = { 
                        offset: Math.random()*10, 
                        rotSpeed: (Math.random()-0.5)*0.01 
                    };
                    g.add(c);
                    this.objects.supplyCrates.push(c);
                }
                this.scene.add(g);
            },

            buildBoat: function() {
                const g = new THREE.Group();
                const shape = new THREE.Shape();
                shape.moveTo(0,0);
                shape.bezierCurveTo(2,0, 2,8, 0,10); 
                shape.bezierCurveTo(-2,8, -2,0, 0,0); 
                const geo = new THREE.ExtrudeGeometry(shape, {depth:2.5, bevelEnabled:true, bevelSize:0.2, bevelThickness:0.2});
                geo.rotateX(Math.PI/2); geo.translate(0, 1.5, -5);
                const hull = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({color:0x4e342e}));
                g.add(hull);

                const mast = new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.2,10), new THREE.MeshStandardMaterial({color:0x3e2723}));
                mast.position.set(0, 5, 0); g.add(mast);
                
                const sailShape = new THREE.Shape();
                sailShape.moveTo(0,0); sailShape.lineTo(0,7); sailShape.lineTo(5,1); sailShape.lineTo(0,0);
                const sailGeo = new THREE.ExtrudeGeometry(sailShape, {depth:0.1, bevelEnabled:false});
                const sail = new THREE.Mesh(sailGeo, new THREE.MeshStandardMaterial({color:0xeeeeee, side:2}));
                sail.position.set(0, 2, 0.2); sail.rotation.y=Math.PI/2; g.add(sail);

                const cannon = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.4,1.5), new THREE.MeshStandardMaterial({color:0x111}));
                cannon.rotation.x = Math.PI/2; cannon.position.set(0, 2, 4); 
                this.objects.cannon = cannon; g.add(cannon);

                const bl = new THREE.PointLight(0xffaa00, 0, 15); bl.position.set(0, 4, -4); bl.name="boatLight";
                const lm = new THREE.Mesh(new THREE.DodecahedronGeometry(0.3), new THREE.MeshBasicMaterial({color:0xffd700}));
                lm.position.set(0, 4, -4); g.add(lm); g.add(bl);

                g.position.set(0,0,150); g.rotation.y = Math.PI;
                this.objects.boat = g;
                this.scene.add(g);
            },

            buildEffects: function() {
                const cvs = document.createElement('canvas'); cvs.width=32; cvs.height=32;
                const ctx = cvs.getContext('2d');
                const gr = ctx.createRadialGradient(16,16,0,16,16,16);
                gr.addColorStop(0,'rgba(255,200,0,1)'); gr.addColorStop(1,'rgba(255,200,0,0)');
                ctx.fillStyle=gr; ctx.fillRect(0,0,32,32);
                const tex = new THREE.CanvasTexture(cvs);

                const fGeo = new THREE.BufferGeometry();
                const fPos = new Float32Array(450); 
                for(let i=0; i<450; i++) fPos[i] = (Math.random()-0.5)*80;
                fGeo.setAttribute('position', new THREE.BufferAttribute(fPos, 3));
                const fMat = new THREE.PointsMaterial({color:0xffaa00, size:0.8, map:tex, transparent:true, blending:THREE.AdditiveBlending, depthWrite:false});
                this.objects.fireflies = new THREE.Points(fGeo, fMat);
                this.scene.add(this.objects.fireflies);

                this.objects.birds = new THREE.Group();
                const bGeo = new THREE.BufferGeometry();
                bGeo.setAttribute('position', new THREE.Float32BufferAttribute([0,0,0, 0.5,0,0.5, -0.5,0,0.5], 3));
                for(let i=0; i<20; i++) {
                    const b = new THREE.Mesh(bGeo, new THREE.MeshBasicMaterial({color:0xffffff, side:2}));
                    b.position.set((Math.random()-0.5)*60, 50+Math.random()*15, (Math.random()-0.5)*60);
                    this.objects.birds.add(b);
                }
                this.scene.add(this.objects.birds);

                this.objects.moon = new THREE.Mesh(new THREE.SphereGeometry(20), new THREE.MeshBasicMaterial({color:0xfffee0}));
                this.objects.moon.position.set(-100, 100, -150);
                this.objects.moon.visible = false;
                this.scene.add(this.objects.moon);
            },

            buildLanterns: function() {
                this.objects.lanterns = new THREE.Group();
                const geo = new THREE.CylinderGeometry(0.3, 0.3, 0.6, 8);
                const mat = new THREE.MeshStandardMaterial({color:0xff4422, emissive:0xff4400, emissiveIntensity:0.5});
                for(let i=0; i<15; i++) {
                    const l = new THREE.Mesh(geo, mat);
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 25 + Math.random() * 40;
                    l.position.set(Math.cos(angle)*radius, 0.5, Math.sin(angle)*radius);
                    const pl = new THREE.PointLight(0xffaa00, 0.5, 8);
                    pl.position.y = 0.5; l.add(pl);
                    l.userData = { offset: Math.random() * 100, speed: 0.5 + Math.random() * 0.5 };
                    this.objects.lanterns.add(l);
                }
                this.scene.add(this.objects.lanterns);
            },

            buildMinimap: function() {
                this.minimap.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.minimap.renderer.setSize(200, 200);
                this.minimap.renderer.setClearColor(0x000000, 0);
                document.getElementById('minimap').appendChild(this.minimap.renderer.domElement);

                this.minimap.camera = new THREE.OrthographicCamera(-120, 120, 120, -120, 1, 1000);
                this.minimap.camera.position.set(0, 100, 0);
                this.minimap.camera.lookAt(0, 0, 0);
                this.minimap.scene = new THREE.Scene();
                
                const grid = new THREE.GridHelper(300, 15, 0x5d4037, 0x333333);
                this.minimap.scene.add(grid);

                const islandDot = new THREE.Mesh(new THREE.CircleGeometry(25, 32), new THREE.MeshBasicMaterial({color: 0x2e5a1c}));
                this.minimap.scene.add(islandDot);
                const dockDot = new THREE.Mesh(new THREE.PlaneGeometry(10, 30), new THREE.MeshBasicMaterial({color: 0x4e342e}));
                dockDot.position.set(0,0,45);
                this.minimap.scene.add(dockDot);
            },

            shoot: function() {
                if(!this.objects.boat) return;
                const particle = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color:0xffaa00}));
                const startPos = this.objects.boat.localToWorld(new THREE.Vector3(0, 2, 5)); 
                particle.position.copy(startPos);
                this.scene.add(particle);
                
                const vel = new THREE.Vector3(0, 10, 20).applyAxisAngle(new THREE.Vector3(0,1,0), this.objects.boat.rotation.y).normalize().multiplyScalar(1.5);
                
                const anim = () => {
                    particle.position.add(vel);
                    vel.y -= 0.02; 
                    if(particle.position.y < 0) {
                        this.scene.remove(particle);
                        this.createExplosion(particle.position); 
                    } else {
                        requestAnimationFrame(anim);
                    }
                };
                anim();
            },

            createExplosion: function(pos) {
                const count = 50;
                const geo = new THREE.BufferGeometry();
                const positions = [];
                const velocities = [];
                const colors = [];
                const colorPalette = [new THREE.Color(0xffd700), new THREE.Color(0x00ffff), new THREE.Color(0xff00ff)];
                
                for(let i=0; i<count; i++) {
                    positions.push(pos.x, pos.y, pos.z);
                    const speed = Math.random()*0.8 + 0.2;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.random() * Math.PI;
                    velocities.push(
                        Math.sin(phi)*Math.cos(theta)*speed,
                        Math.sin(phi)*Math.sin(theta)*speed,
                        Math.cos(phi)*speed
                    );
                    const c = colorPalette[Math.floor(Math.random()*colorPalette.length)];
                    colors.push(c.r, c.g, c.b);
                }
                
                geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                
                const mat = new THREE.PointsMaterial({
                    size: 1.2, vertexColors: true, 
                    transparent: true, blending: THREE.AdditiveBlending
                });
                
                const points = new THREE.Points(geo, mat);
                this.scene.add(points);
                this.objects.explosions.push({ mesh: points, vels: velocities, age: 0, gravity: 0.01, drag: 0.98 });
            },

            createSplash: function(pos) {
                const count = 30;
                const geo = new THREE.BufferGeometry();
                const positions = [];
                const velocities = [];
                
                for(let i=0; i<count; i++) {
                    positions.push(pos.x, 0.5, pos.z);
                    velocities.push((Math.random()-0.5)*2, Math.random()*3 + 1, (Math.random()-0.5)*2);
                }
                
                geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                const mat = new THREE.PointsMaterial({
                    color: 0xffffff, size: 1.5, transparent: true, opacity: 0.8
                });
                
                const points = new THREE.Points(geo, mat);
                this.scene.add(points);
                this.objects.explosions.push({ mesh: points, vels: velocities, age: 0, gravity: 0.1, drag: 0.95 });
            },

            toggleTheme: function() {
                this.state.night = !this.state.night;
                const t = this.state.night ? CONFIG.night : CONFIG.day;
                document.getElementById('theme-btn').innerText = this.state.night ? 'üåô' : '‚òÄÔ∏è';
                
                document.getElementById('ww-status').innerText = this.state.night ? 'STATUS: MIDNIGHT' : 'STATUS: SUNRISE';
                document.getElementById('ww-temp').innerText = this.state.night ? 'TEMP: 8¬∞C' : 'TEMP: 14¬∞C';

                const dur = 2;
                gsap.to(this.lights.amb, {intensity: t.ambient, duration: dur});
                gsap.to(this.lights.dir, {intensity: t.dirIntensity, duration: dur});
                const c = new THREE.Color(t.sunColor);
                gsap.to(this.lights.dir.color, {r:c.r, g:c.g, b:c.b, duration: dur});
                
                const f = new THREE.Color(t.fog);
                gsap.to(this.scene.fog.color, {r:f.r, g:f.g, b:f.b, duration: dur});
                gsap.to(this.scene.background, {r:f.r, g:f.g, b:f.b, duration: dur});
                gsap.to(this.scene.fog, {density: t.fogDensity, duration: dur});

                const bl = this.objects.boat.getObjectByName('boatLight');
                const hl = this.scene.getObjectByName('houseLight');
                if(bl) gsap.to(bl, {intensity: this.state.night?2:0, duration:1});
                if(hl) gsap.to(hl, {intensity: this.state.night?2:0, duration:1});

                if(this.objects.moon) this.objects.moon.visible = this.state.night;
                if(this.objects.birds) this.objects.birds.visible = !this.state.night;
                if(this.objects.fireflies) gsap.to(this.objects.fireflies.material, {opacity: this.state.night?1:0.2, duration:1});
                
                if(this.objects.lanterns) {
                    this.objects.lanterns.children.forEach(l => {
                        const pl = l.children[0];
                        gsap.to(l.material, {emissiveIntensity: this.state.night?1:0.2, duration:1});
                        if(pl) gsap.to(pl, {intensity: this.state.night?0.8:0.2, duration:1});
                    });
                }

                this.updateSky(t.sky.elevation, t.sky.azimuth);
            },

            updatePhysics: function() {
                if(this.state.docked || this.state.talking) return;
                const b = this.physics; const k = this.state.keys;
                
                if(k.w) b.speed += b.accel;
                if(k.s) b.speed -= b.accel;
                b.speed = Math.max(Math.min(b.speed, b.max), -b.max/2);
                b.speed *= b.fric;

                if(Math.abs(b.speed)>0.001) {
                    const dir = b.speed>0 ? 1:-1;
                    if(k.a) b.angle += b.turn * dir;
                    if(k.d) b.angle -= b.turn * dir;
                }

                b.vel.set(Math.sin(b.angle), 0, Math.cos(b.angle)).multiplyScalar(b.speed);
                
                const nextPos = this.objects.boat.position.clone().add(b.vel);
                const distFromCenter = nextPos.length();
                const inDockX = nextPos.x > -6 && nextPos.x < 6;
                const inDockZ = nextPos.z > 30 && nextPos.z < 62;
                
                if (distFromCenter < 35 || (inDockX && inDockZ)) {
                   b.speed *= -0.5; 
                } else {
                   this.objects.boat.position.add(b.vel);
                }

                this.objects.boat.rotation.y = b.angle;
                
                const turn = (k.d?-1:(k.a?1:0));
                this.objects.boat.rotation.z = THREE.MathUtils.lerp(this.objects.boat.rotation.z, turn*0.2*(Math.abs(b.speed)/b.max), 0.05);
                this.objects.boat.rotation.x = -b.speed*0.2;
                this.objects.boat.position.y = Math.sin(performance.now()*0.0015)*0.2;

                this.controls.target.copy(this.objects.boat.position);
                this.controls.update();

                // NPC INTERACTION LOGIC
                const dist = this.objects.boat.position.distanceTo(new THREE.Vector3(0,0,50));
                const prompt = document.getElementById('npc-prompt');
                if(dist < 30 && !this.state.talking) {
                    this.state.canTalk = true;
                    prompt.style.display = 'flex';
                } else {
                    this.state.canTalk = false;
                    prompt.style.display = 'none';
                }
            },

            startDialogue: function() {
                this.state.talking = true; this.physics.speed = 0;
                document.getElementById('npc-prompt').style.display = 'none';
                
                const target = this.objects.npc.position.clone().add(new THREE.Vector3(0,2,0));
                gsap.to(this.camera.position, {x:10, y:8, z:65, duration:1.5, ease:"power2.out"});
                gsap.to(this.controls.target, {x:target.x, y:target.y, z:target.z, duration:1.5});

                document.getElementById('rpg-ui').classList.add('active');
                this.runDialog('start');
            },

            runDialog: function(id) {
                const nodes = {
                    start: { t: "Hail, Traveler. The Sanctuary lies beyond these tides.", opts:[{l:"I seek entry.", n:'open'}, {l:"Who are you?", n:'who'}] },
                    who: { t: "I am the Keeper of the Tides. I watch over Yassin's voyage.", opts:[{l:"Show me the chart.", n:'open'}, {l:"Fair winds.", n:'close'}] },
                    open: { t: "The currents are favorable. Proceed.", act:'enter' },
                    close: { t: "Safe travels.", act:'exit' }
                };

                const d = nodes[id];
                const txt = document.getElementById('rpg-text');
                const opts = document.getElementById('rpg-options');
                txt.textContent = ""; 
                opts.innerHTML = "";
                
                let i=0;
                const t = setInterval(()=>{
                    txt.textContent += d.t[i]; i++;
                    if(i>=d.t.length) {
                        clearInterval(t);
                        if(d.opts) d.opts.forEach(o => {
                            const b = document.createElement('div');
                            b.className='rpg-btn'; b.innerText='> '+o.l;
                            b.onclick=()=>this.runDialog(o.n);
                            opts.appendChild(b);
                        });
                        else setTimeout(()=>d.act==='enter'?this.enterPort():this.endDialog(), 1000);
                    }
                }, 35);
            },

            endDialog: function() {
                document.getElementById('rpg-ui').classList.remove('active');
                this.state.talking = false;
                gsap.to(this.camera.position, {x:0, y:20, z:this.objects.boat.position.z+40, duration:1.5});
            },

            enterPort: function() {
                document.getElementById('rpg-ui').classList.remove('active');
                this.state.docked = true; this.controls.enabled = false;
                gsap.to(this.camera.position, {x:30, y:30, z:30, duration:2, ease:"power2.inOut"});
                gsap.to(this.controls.target, {x:0, y:20, z:0, duration:2});
                setTimeout(()=>document.getElementById('portfolio-modal').classList.add('active'), 1200);
            },

            closePortfolio: function() {
                document.getElementById('portfolio-modal').classList.remove('active');
                this.state.docked = false; this.state.talking = false; this.controls.enabled = true;
                this.physics.speed = -0.8;
                gsap.to(this.objects.boat.position, {z:80, duration:2});
                gsap.to(this.camera.position, {x:0, y:20, z:120, duration:2});
            },

            nav: function(id) {
                document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
                document.getElementById('sec-'+id).classList.add('active');
                document.querySelectorAll('.p-nav').forEach(e=>e.classList.remove('active'));
                event.target.classList.add('active');
            },

            onResize: function() {
                this.camera.aspect = window.innerWidth/window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            },

            animate: function() {
                requestAnimationFrame(() => this.animate());
                const t = performance.now()*0.001;
                if(this.water) this.water.material.uniforms['time'].value += 1.0/60.0;
                
                this.updatePhysics(t);

                if(this.objects.npc) this.objects.npc.position.y = 2.5 + Math.sin(t*3)*0.3; 

                if(this.objects.fireflies) {
                    this.objects.fireflies.position.copy(this.objects.boat.position);
                    this.objects.fireflies.position.y += 5;
                    const p = this.objects.fireflies.geometry.attributes.position.array;
                    for(let i=1; i<p.length; i+=3) p[i] += Math.sin(t*2+i)*0.05;
                    this.objects.fireflies.geometry.attributes.position.needsUpdate = true;
                }
                
                if(this.objects.lanterns) {
                    this.objects.lanterns.children.forEach(l => {
                        l.position.y = 0.5 + Math.sin(t * l.userData.speed + l.userData.offset) * 0.2;
                    });
                }
                
                // Supply Crates Bobbing & Rotating
                this.objects.supplyCrates.forEach(c => {
                    c.position.y = Math.sin(t + c.userData.offset)*0.3;
                    c.rotation.x = Math.sin(t*0.5 + c.userData.offset)*0.1;
                    c.rotation.z = Math.cos(t*0.3 + c.userData.offset)*0.1;
                    c.rotation.y += c.userData.rotSpeed;
                });

                // Whale Animation
                if(this.objects.whale) {
                    this.state.whaleState.t += 0.005;
                    const cycle = this.state.whaleState.t % 12;
                    if(cycle > 8) { // Jumping
                        const jumpT = (cycle - 8) / 4;
                        const y = Math.sin(jumpT * Math.PI) * 40 - 10;
                        const z = -120 + jumpT * 100;
                        this.objects.whale.position.set(-50, y, z);
                        this.objects.whale.rotation.x = -Math.PI/4 + jumpT * Math.PI/2;
                        
                        if(jumpT > 0.9 && !this.state.whaleState.splashed) {
                            this.createSplash(this.objects.whale.position);
                            this.state.whaleState.splashed = true;
                        }
                    } else {
                        this.state.whaleState.splashed = false;
                        this.objects.whale.position.y = -30;
                    }
                }

                for(let i = this.objects.explosions.length - 1; i >= 0; i--) {
                    const ex = this.objects.explosions[i];
                    ex.age += 0.015;
                    const pos = ex.mesh.geometry.attributes.position.array;
                    for(let j=0; j<ex.vels.length; j+=3) { 
                        pos[j] += ex.vels[j];
                        pos[j+1] += ex.vels[j+1];
                        pos[j+2] += ex.vels[j+2];
                        
                        // Gravity & Drag
                        ex.vels[j+1] -= (ex.gravity || 0.01); 
                        if(ex.drag) {
                            ex.vels[j] *= ex.drag;
                            ex.vels[j+1] *= ex.drag;
                            ex.vels[j+2] *= ex.drag;
                        }
                    }
                    ex.mesh.geometry.attributes.position.needsUpdate = true;
                    ex.mesh.material.opacity = Math.max(0, 1 - ex.age);
                    if(ex.age >= 1) {
                        this.scene.remove(ex.mesh);
                        this.objects.explosions.splice(i, 1);
                    }
                }

                if(this.objects.boat && this.minimap.renderer && this.state.mapVisible) {
                    this.minimap.camera.position.x = this.objects.boat.position.x;
                    this.minimap.camera.position.z = this.objects.boat.position.z;
                    this.minimap.renderer.render(this.minimap.scene, this.minimap.camera);
                    const arrow = document.getElementById('minimap-arrow');
                    if(arrow) arrow.style.transform = `translate(-50%, -50%) rotate(${-this.objects.boat.rotation.y}rad)`;
                }

                this.renderer.render(this.scene, this.camera);
            }
        };

        Game.init();
    </script>
</body>
</html>